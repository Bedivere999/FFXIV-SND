  --[[

  ****************************************
  *            Fate Farming              * 
  ****************************************

  ***********
  * Version *
  *  0.0.7  *
  ***********

    -> 0.0.7: made the code look Prettier
              and fixed some stuff like you will go a bit higher then the fate and then dismount all the way hopefully preventing trying to fly into buildings
              added functions to call them to make the loop code look smaller
              hopefully fixed the problem that it spams in chat (if still happen please report)
              should mount when there is no fate and u get in combat
    -> 0.0.6: you will now dismount upon entering the fate (hopefully) instead pathing to the center
              if you got to the spot where u "should" dismount but don't dismount, triggers a counter that will start and change the path to another location to prevent being stuck cause of some stones
              Removed auto rs settings now need toset the engage setting in rs to Previously engaged targets (look at Required Plugins)
              when no fate exists it won't go to 0.0.0 anymore and just stand still till a new fate spawn 
    -> 0.0.5: fixed stuff with rs and thanks to UcanPatates for refining the code a bit and fixing some stuff. and all the others that helpt on this version and gave their feedback
    -> 0.0.4: fixed more bugs or so...
    -> 0.0.3: fixed some bugs with rs a and so

  Created by: Prawellp

  Known Issues: the Ping if your almost capped will keep spamming if there is no fate
                it can happen if u switch zones after using it it won't work and u would need to relog

  *********************
  *  Required Plugins *
  *********************


  Plugins that are used are:
  -> VNavmesh (for pathing) AND Visland: https://puni.sh/api/repository/veyn
  -> Pandora : https://love.puni.sh/ment.json
  -> RotationSolver Reborn : https://raw.githubusercontent.com/FFXIV-CombatReborn/CombatRebornRepo/main/pluginmaster.json
     -> Target -> activate "Select only Fate targets in Fate" and "Target Fate priority"
     -> Target -> "Engage settings" set to "Previously engaged targets (enagegd on countdown timer)"
  -> Something Need Doing [Expanded Edition] : https://puni.sh/api/repository/croizat
]]

--[[

  **************
  *  Settings  *
  **************
  ]]

  FateS = true
  -- activates the Fate settings in Pandora
  -- Auto-Sync fate and target fate mobs (kind of needed ig)
  
  ChocoboS = true
  -- activates the Chocobo settings in Pandora
  -- Auto-Summon Chocobo and call him in fight (there is not much time where you are on ground so it will need to use it mid fight)
  
  Announce = 2
  --change this value for how much echos u want in chat 
  --2 is the fate your Moving to and Bicolor gems amount
  --1 is only Bicolor gems
  --0 is nothing
  --echos will appear after it found a new fate 
  
  --[[
  
    ************
    *  Script  *
    *   Start  *
    ************
  
  ]]
  
----------------------------------Settings----------------------------------------------
  if ChocoboS == true then
  PandoraSetFeatureState("Auto-Summon Chocobo", true) 
  PandoraSetFeatureConfigState("Auto-Summon Chocobo", "Use whilst in combat", true)
  elseif ChocoboS == false then
    yield("/e Sad Chocobo noises...")
  end

  if FateS == true then
  PandoraSetFeatureState("Auto-Sync FATEs", true) 
  PandoraSetFeatureState("FATE Targeting Mode", true) 
  yield("/wait 1")
  elseif FateS == false then
  yield("/e I hope u have something that syncs and targets them")
  end
-------------------------------------------------------------------------------------


------------------------------functions----------------------------------------------
  function FateLocation()
  fates = GetActiveFates()
  minDistance = 50000
  fateId = 0
  for i = 0, fates.Count-1 do
    if GetFateDuration(fates[i]) > 0 then
      distance = GetDistanceToPoint(GetFateLocationX(fates[i]), GetFateLocationY(fates[i]), GetFateLocationZ(fates[i]))
      if distance < minDistance then
        minDistance = distance
        fateId = fates[i]
      end
    end
  end

  fateX = GetFateLocationX(fateId)
  fateY = GetFateLocationY(fateId)+18
  fateZ = GetFateLocationZ(fateId)
  LogInfo(fateX.." , "..fateY.." , "..fateZ)

  if fateX == 0 and fateY == 18 and fateZ == 0 then
    noFate = true
    yield("/vnavmesh stop")
    PathStop()
  end
  
  if fateX ~= 0 and fateY ~= 18 and fateZ ~= 0 then
  noFate = false
  PathfindAndMoveTo(fateX, fateY, fateZ, true)
  if Announce == 2 then
  yield("/echo Moving to Fate: "..fateId)
  end
  end
end


function enemyPathing()
while GetDistanceToTarget() > 3.5 do
  local enemy_x = GetTargetRawXPos()
  local enemy_y = GetTargetRawYPos()
  local enemy_z = GetTargetRawZPos()
  if PathIsRunning() == false then 
  PathfindAndMoveTo(enemy_x, enemy_y, enemy_z)
  end
  yield("/wait 0.1")
end
end

function noFateSafe()
if noFate == true and fcount == 0 then
  yield("/echo No Fate existing")
  if GetCharacterCondition(26) then
  Name = GetCharacterName()
  PlocX = GetPlayerRawXPos(Name)
  PlocY = GetPlayerRawYPos(Name)+40
  PlocZ = GetPlayerRawZPos(Name)
  yield("/gaction jump")
  yield("/wait 0.5")
  PathfindAndMoveTo(PlocX, PlocY, PlocZ, true)
  PathStop()
  yield("/wait 2")
  end
  fcount = fcount +1
end
end
---------------------------Beginning of the Code------------------------------------
if GetCharacterCondition(4) == false then
  yield('/gaction "mount roulette"')
  yield("/wait 3")
  if GetCharacterCondition(4) == true then
  yield("/gaction jump")
  yield("/wait 2")
end
end
yield("/rotation auto")

--Start of the Code
  while true do
  gems = GetItemCount(26807)

---------------------------Notification tab---------------------------------------
gcount = 0
fcount = 0
  if gems > 900 then
    yield("/e You are Almost capped with ur Bicolor Gems! <se.3>")
    yield("/wait 1")
  end


  if gcount == 0  and fateId ~= 0 and Announce == 1 or Announce == 2 then
    yield("/e Gems: "..gems)
    yield("/wait 0.5")
    gcount = gcount +1
  end
---------------------------------------------------------------------------------

FateLocation()
noFateSafe()

-------------------------------Mount---------------------------------------------
  while PathIsRunning() or PathfindInProgress() and IsInFate() == false do
       if GetCharacterCondition(4) and GetCharacterCondition(77) == false then 
          yield("/gaction jump")
          yield("/wait 0.3")
       end
  end

  if noFate == true and PathIsRunning() or PathfindInProgress() then
    PathStop()
    yield("/vnavmesh stop")
    yield("/wait 2")
  end


  while IsInFate() and GetCharacterCondition(4) do
    yield("/gaction dismount")
    yield("/wait 0.3")
    PathStop()
    yield("/vnavmesh stop")
  end
---------------------------------------------------------------------------------

-------------------------------Fate----------------------------------------------
while IsInFate() do
    PathStop()
    if GetCharacterCondition(4) == true then
      yield("/gaction dismount")
      yield("/wait 2")
      PathStop()
      yield("/vnavmesh stop")
    end
    enemyPathing()
    PathStop()
    yield("/vnavmesh stop")
    yield("/wait 1")
    fcount = 0
    gcount = 0
  end

  --when fate done mount
  while IsInFate() == false and GetCharacterCondition(4) == false do
    PathStop()
    yield("/wait 3")
    yield('/gaction "mount roulette"')
    yield("/wait 3")
    if GetCharacterCondition(4) == true then
    yield("/gaction jump")
    yield("/wait 2")
    end
   end
  --------------------------------------------------------------------------------
  end
