--[[

  ****************************************
  *            Fate Farming              * 
  ****************************************

  ***********
  * Version *
  *  0.0.4  *
  ***********

    -> 0.0.4: fixed more bugs or so...
    -> 0.0.3: fixed some bugs with rs a and so
    -> 0.0.2: Filterd out fates u need to actiavte, 
              added a function that walks to the targetet enemy, 
              added a function that auto turns on Pandora and RS stuff, 
              added a function that checks if ur mounted or not and mounts you at the beginning (last version it tried to mount you even if you already where mounted)
              added a echo notification when ur Bicolor Gems are over 900

  Created by: Prawellp

  Special Thanks to everyone who helped me!

  Known Issues: the Ping if your almost capped will keep spamming if there is no fate

  *********************
  *  Required Plugins *
  *********************


  Plugins that are used are:
  -> VNavmesh (for pathing) AND Visland: https://puni.sh/api/repository/veyn
  -> Pandora : https://love.puni.sh/ment.json
  -> RotationSolver Reborn : https://raw.githubusercontent.com/FFXIV-CombatReborn/CombatRebornRepo/main/pluginmaster.json
     -> Target -> activate "Select only Fate targets in Fate" and "Target Fate priority"
  -> Something Need Doing [Expanded Edition] : https://puni.sh/api/repository/croizat
]]

--[[

  **************
  *  Settings  *
  **************
  ]]

FateS = true
-- activates the Fate settings in Pandora
-- Auto-Sync fate and target fate mobs (kind of needed ig)

ChocoboS = true
-- activates the Chocobo settings in Pandora
-- Auto-Summon Chocobo and call him in fight (there is not much time where you are on ground so it will need to use it mid fight)

Announce = 2
--change this value for how much echos u want in chat 
--2 is FateId and Bicolor gems amount
--1 is only Bicolor gems
--0 is nothing
--echos will appear after it found a new fate 

--[[

  ************
  *  Script  *
  *   Start  *
  ************

]]

--Chocobo settings
if ChocoboS == true then
PandoraSetFeatureState("Auto-Summon Chocobo", true) 
PandoraSetFeatureConfigState("Auto-Summon Chocobo", "Use whilst in combat", true)
elseif ChocoboS == false then
  yield("/e Sad Chocobo noises...")
end

--Fate settings
if FateS == true then
PandoraSetFeatureState("Auto-Sync FATEs", true) 
PandoraSetFeatureState("FATE Targeting Mode", true) 
yield("/wait 1")
elseif FateS == false then
yield("/e I hope u have something that syncs and targets them")
end


--Mounts at the Beginning
if GetCharacterCondition(4) == false then
yield('/gaction "mount roulette"')
yield("/wait 1")
end

--the actual code for the fates and loop
while true do
gems = GetItemCount(26807)

--gets the Closest Fate
fates = GetActiveFates()
minDistance = 50000
fateId = 0
for i = 0, fates.Count-1 do
  if GetFateDuration(fates[i]) > 0 then
    distance = GetDistanceToPoint(GetFateLocationX(fates[i]), GetFateLocationY(fates[i]), GetFateLocationZ(fates[i]))
    if distance < minDistance then
      minDistance = distance
      fateId = fates[i]
    end
  end
end
--ping when your over capped
if gems > 900 then
  yield("/e You are Almost capped with ur Bicolor Gems! <se.3>")
  yield("/wait 1")
  end


--gets the fate location
fateX = GetFateLocationX(fateId)
fateY = GetFateLocationY(fateId)+5
fateZ = GetFateLocationZ(fateId)
LogInfo(fateX.." , "..fateY.." , "..fateZ)

--paths to the fate
PathfindAndMoveTo(fateX, fateY, fateZ, true)

--setting 1 for echo 
if fateId ~= 0 and Announce == 1 then
  yield("/e Gems: "..gems)
end

--setting 2 for echo 
if fateId ~= 0 and Announce == 2 then
  yield("/e FateId:"..fateId)
  yield("/e Gems: "..gems)
end

--jumps when mount lands
while (PathIsRunning() or PathfindInProgress()) do
     if GetCharacterCondition(4) and GetCharacterCondition(77) == false then 
        yield("/gaction jump")
        PathfindAndMoveTo(fateX, fateY, fateZ, true)
        yield("/wait 0.3")
     end
end

--dismount when in fate
while IsInFate() and GetCharacterCondition(4) do
     yield("/gaction dismount")
     yield("/wait 0.3")
     end

--turn rotation on when in fate
if IsInFate() then
  yield("/rotation auto")
  yield("/wait 0.5")
end

--locates the mobs in the fate and path to them
while IsInFate() do
  if GetCharacterCondition(4) == true then
    yield("/gaction dismount")
    yield("/wait 2")
    PathStop()
  end
while GetDistanceToTarget() > 3.5 do
    local enemy_x = GetTargetRawXPos()
    local enemy_y = GetTargetRawYPos()
    local enemy_z = GetTargetRawZPos()
    if PathIsRunning() == false then 
    PathfindAndMoveTo(enemy_x, enemy_y, enemy_z)
    end
    yield("/wait 0.1")
  end
    PathStop()
    yield("/wait 1")
end

--disables rs when out of fate 
if IsInFate() == false and GetCharacterCondition(26) == false then
  yield("/rotation cancel")
  yield("/wait 1")
end

--starts rs auto when ur getting attacked outside the fate (had some Issues that an non fate mob attacked and you couldnt mount and didn't attack)
if IsInFate() == false and GetCharacterCondition(26) then 
  yield("/rotation auto")
end

--when fate done mount
while IsInFate() == false and GetCharacterCondition(4) == false do
     PathStop()
     yield('/gaction "mount roulette"')
     yield("/rotation cancel")
     yield("/wait 5")
    end

if fateX == 0 and fateY == 0 and fateZ == 0 then
      PathStop()
end
end

