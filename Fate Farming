--[[

  ****************************************
  *            Fate Farming              * 
  ****************************************

  ***********
  * Version *
  *  0.0.6  *
  ***********

    -> 0.0.6: you will now dismount upon entering the fate (hopefully) instead pathing to the center
              if you got to the spot where u "should" dismount but don't dismount, triggers a counter that will start and change the path to another location to prevent being stuck cause of some stones
              Removed auto rs settings now need toset the engage setting in rs to Previously engaged targets (look at Required Plugins)
              when no fate exists it won't go to 0.0.0 anymore and just stand still till a new fate spawn 
    -> 0.0.5: fixed stuff with rs and thanks to UcanPatates for refining the code a bit and fixing some stuff. and all the others that helpt on this version and gave their feedback
    -> 0.0.4: fixed more bugs or so...
    -> 0.0.3: fixed some bugs with rs a and so
    -> 0.0.2: Filterd out fates u need to actiavte, 
              added a function that walks to the targetet enemy, 
              added a function that auto turns on Pandora and RS stuff, 
              added a function that checks if ur mounted or not and mounts you at the beginning (last version it tried to mount you even if you already where mounted)
              added a echo notification when ur Bicolor Gems are over 900

  Created by: Prawellp

  Known Issues: the Ping if your almost capped will keep spamming if there is no fate
                it can happen if u switch zones after using it it won't work and u would need to relog

  *********************
  *  Required Plugins *
  *********************


  Plugins that are used are:
  -> VNavmesh (for pathing) AND Visland: https://puni.sh/api/repository/veyn
  -> Pandora : https://love.puni.sh/ment.json
  -> RotationSolver Reborn : https://raw.githubusercontent.com/FFXIV-CombatReborn/CombatRebornRepo/main/pluginmaster.json
     -> Target -> activate "Select only Fate targets in Fate" and "Target Fate priority"
     -> Target -> "Engage settings" set to "Previously engaged targets (enagegd on countdown timer)"
  -> Something Need Doing [Expanded Edition] : https://puni.sh/api/repository/croizat
]]

--[[

  **************
  *  Settings  *
  **************
  ]]

  FateS = true
  -- activates the Fate settings in Pandora
  -- Auto-Sync fate and target fate mobs (kind of needed ig)
  
  ChocoboS = true
  -- activates the Chocobo settings in Pandora
  -- Auto-Summon Chocobo and call him in fight (there is not much time where you are on ground so it will need to use it mid fight)
  
  Announce = 2
  --change this value for how much echos u want in chat 
  --2 is the fate your Moving to and Bicolor gems amount
  --1 is only Bicolor gems
  --0 is nothing
  --echos will appear after it found a new fate 
  
  --[[
  
    ************
    *  Script  *
    *   Start  *
    ************
  
  ]]
  
  --Chocobo settings
  if ChocoboS == true then
  PandoraSetFeatureState("Auto-Summon Chocobo", true) 
  PandoraSetFeatureConfigState("Auto-Summon Chocobo", "Use whilst in combat", true)
  elseif ChocoboS == false then
    yield("/e Sad Chocobo noises...")
  end
  
  --Fate settings
  if FateS == true then
  PandoraSetFeatureState("Auto-Sync FATEs", true) 
  PandoraSetFeatureState("FATE Targeting Mode", true) 
  yield("/wait 1")
  elseif FateS == false then
  yield("/e I hope u have something that syncs and targets them")
  end
  
  
  --Mounts at the Beginning
  if GetCharacterCondition(4) == false then
  yield('/gaction "mount roulette"')
  yield("/wait 1")
  end
  yield("/rotation auto")

  --the actual code for the fates and loop
  while true do
  gems = GetItemCount(26807)
  
  --gets the Closest Fate
  fates = GetActiveFates()
  minDistance = 50000
  fateId = 0
  for i = 0, fates.Count-1 do
    if GetFateDuration(fates[i]) > 0 then
      distance = GetDistanceToPoint(GetFateLocationX(fates[i]), GetFateLocationY(fates[i]), GetFateLocationZ(fates[i]))
      if distance < minDistance then
        minDistance = distance
        fateId = fates[i]
      end
    end
  end
  --ping when your over capped
  if gems > 900 then
    yield("/e You are Almost capped with ur Bicolor Gems! <se.3>")
    yield("/wait 1")
    end
  
  
  --gets the fate location
  fateX = GetFateLocationX(fateId)+25
  fateY = GetFateLocationY(fateId)+5
  fateZ = GetFateLocationZ(fateId)+25
  LogInfo(fateX.." , "..fateY.." , "..fateZ)
  
  --paths to the fate
  if fateX ~= 0 and fateY ~= 5 and fateZ ~= 0 then
  PathfindAndMoveTo(fateX, fateY, fateZ, true)
  if fateId ~= 0 and Announce == 2 then
  yield("/echo Moving to Fate: "..fateId)
  end
  end

  if fateX == 0 and fateY == 5 and fateZ == 0 then
    noFate = true
    yield("/echo No Fate existing")
    PathStop()
    yield("/wait 2")
  end

if fateX ~= 0 and fateY ~= 5 and fateZ ~= 0 then
   noFate = false 
   yield("/wait 0.5")
  end
  
  --setting 1 for echo 
  if fateId ~= 0 and Announce == 1 or Announce == 2 and noFate == false then
    yield("/e Gems: "..gems)
    yield("/wait 0.5")
  end
  
  --jumps when mount lands
  while PathIsRunning() or PathfindInProgress() and IsInFate() == false do
       if GetCharacterCondition(4) and GetCharacterCondition(77) == false then 
          yield("/gaction jump")
          yield("/wait 0.3")
       end
  end

  if noFate == true and PathIsRunning() or PathfindInProgress() then
    PathStop()
    yield("/vnavmesh stop")
    yield("/wait 2")
  end

  dcount = 0
  --dismount when in fate
  while IsInFate() and GetCharacterCondition(4) do
    yield("/gaction dismount")
    yield("/wait 0.3")
    dcount = dcount + 1
    yield("/echo "..dcount)
    if dcount == 5 then
        fateX = GetFateLocationX(fateId)+10
        fateY = GetFateLocationY(fateId)+5
        fateZ = GetFateLocationZ(fateId)+10
        PathfindAndMoveTo(fateX, fateY, fateZ, true)
        yield("/wait 5")
    end
    if dcount == 10 then
        fateX = GetFateLocationX(fateId)+20
        fateY = GetFateLocationY(fateId)+5
        fateZ = GetFateLocationZ(fateId)+20
        PathfindAndMoveTo(fateX, fateY, fateZ, true)
        yield("/wait 5")
    end
    if dcount == 20 then
        fateX = GetFateLocationX(fateId)-20
        fateY = GetFateLocationY(fateId)+10
        fateZ = GetFateLocationZ(fateId)-20
        PathfindAndMoveTo(fateX, fateY, fateZ)
        yield("/wait 5")
    end
    yield("/wait 0.5")
    PathStop()
    yield("/vnavmesh stop")
  end
    if dcount > 20 and GetCharacterCondition(26) and GetCharacterCondition(4) == false then
        PathStop()
    end
  
  --locates the mobs in the fate and path to them
  while IsInFate() do
    if GetCharacterCondition(4) == true then
      yield("/gaction dismount")
      yield("/wait 2")
      PathStop()
      yield("/vnavmesh stop")
    end
  while GetDistanceToTarget() > 3.5 do
      local enemy_x = GetTargetRawXPos()
      local enemy_y = GetTargetRawYPos()
      local enemy_z = GetTargetRawZPos()
      if PathIsRunning() == false then 
      PathfindAndMoveTo(enemy_x, enemy_y, enemy_z)
      end
      yield("/wait 0.1")
    end
    PathStop()
    yield("/vnavmesh stop")
      yield("/wait 1")
  end

  --when fate done mount
  while IsInFate() == false and GetCharacterCondition(4) == false do
       PathStop()
       yield('/gaction "mount roulette"')
       yield("/wait 5")
      end
  if fateX == 0 and fateY == 5 and fateZ == 0 then
    PathStop()
  end
  end
